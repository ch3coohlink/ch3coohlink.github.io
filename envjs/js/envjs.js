const body = document.body; body.innerHTML = ""
$.store = idb(assign(scope($), { name: "envjs" }))
css("body", { margin: 0 })
style(body, { paddingBottom: "50%" })

const preload = '{"global-state-location":[{"v":"const mktag = t => $[t] = (...a) => dom({tag:t, child:a})\\n\\"h1 p br pre b\\".split(\\" \\").forEach(mktag)\\nstyle(document.documentElement, {width:\\"50%\\"})\\nstyle(document.body, {margin:8})\\ncss(\\".right\\",{ textAlign:\\"right\\", marginRight:10 })\\ncss(\\"button\\", {verticalAlign:\\"bottom\\"})\\n\\nconst toggle = () => style(exd0, {height:(e0open=!e0open)?0:10000})\\n$.exb0 = dom({tag:\\"button\\", child:\\"ç‚¹æˆ‘å±•å¼€/æ”¶èµ·éšè—å†…å®¹\\", onclick: toggle})\\n$.exd0 = dom({innerHTML:\\"å‡è®¾æˆ‘è¦æŠŠè¿™æ®µæ–‡æœ¬å†™ä¸Šä¸€åƒé\\".repeat(1000)+\\"<br>ä½ çœ‹ç”¨jså†™å°±å¾ˆå®¹æ˜“å§\\"})\\n$.e0open = false, toggle(), style(exd0, {overflow:\\"hidden\\", transition:\\"all 1s ease-in-out\\"})\\n\\nelm(document.body, {child:[ h1(\\"æ–‡å­¦ç¼–ç¨‹å®è·µ2\\"),\\ndom({tag:\\"h3\\", child:\\"â€”â€”å…³äºå¦‚ä½•åˆ†è§£è½¯ä»¶ï¼Œå•ç‹¬å¼€å‘ï¼Œåˆ†åˆ«æµ‹è¯•ï¼Œå¹¶å°†ç»„ä»¶åˆæˆä¸ºæ•´ä½“çš„è‰ºæœ¯\\", class:\\"right\\"}),\\ndom({tag:\\"p\\", child:\\"å¹»æƒ³è½¯ä»¶ç ”ç©¶@2022\\", class:\\"right\\"}),\\n\\"é¦–å…ˆï¼Œè®©æˆ‘è§£é‡Šä¸€ä¸‹è¿™ä¸ªé¡µé¢çš„åŠŸèƒ½ï¼Œè¿™æ˜¯ä¸€ä¸ªæ²™ç›’ç¯å¢ƒï¼Œå·¦è¾¹æ˜¯ç¼–è¾‘å™¨ï¼Œå³è¾¹æ˜¯å¯¹åº”çš„é¡µé¢ã€‚\\", br(),\\n\\"æ²™ç›’ç¯å¢ƒæ„å‘³ç€ä½ åœ¨jsé‡Œåšçš„æ“ä½œä¸ä¼šå½±å“åˆ°æ²™ç›’ä¹‹å¤–çš„ä¸œè¥¿ï¼Œå°±åƒåœ¨ä¸€ä¸ªiframeé‡Œé‚£æ ·ï¼ˆè™½ç„¶å®é™…ä¸Šä¸æ˜¯iframeï¼‰ã€‚\\", br(), br(),\\n\\"è¿™æ ·ä¸€ä¸ªå·¥å…·ï¼Œå®ƒçš„ä¸€ç§ç®€å•çš„åº”ç”¨æ˜¯å†™æ–‡ç« ï¼Œå°±åƒæˆ‘ç°åœ¨åšçš„ä¸€æ ·ã€‚\\", br(),\\n\\"ä½¿ç”¨jsæ“ä½œdomï¼Œç¼–å†™æ ·å¼ï¼Œå……åˆ†è¿ç”¨æµè§ˆå™¨æä¾›çš„æ’ç‰ˆåŠŸèƒ½ã€‚\\", br(),\\n\\"å®é™…ä¸Šï¼Œè¿˜ä¸æ­¢äºæ­¤ï¼Œä½ å¯ä»¥ä½¿ç”¨jsç®€åŒ–è®¸å¤šé‡å¤çš„æ–‡æœ¬ç¼–è¾‘æ“ä½œã€‚\\", br(),\\n\\"ï¼ˆè¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆç¬¨çš„ä¾‹å­ï¼Œåªè¦ç†è§£åˆ°æˆ‘çš„æ„æ€å°±å¥½ï¼š\\", exb0, \\"ï¼‰\\", exd0, br(),\\n\\"ä¸è¿‡ç¼–å†™æ–‡æ¡£è¿™å¹¶ä¸æ˜¯è¿™ç¯‡æ–‡ç« çš„ä¸»é¢˜ï¼Œæˆ‘æƒ³è®¨è®ºçš„æ˜¯ä¸€ä¸ªæ›´ä¸ªäººçš„é—®é¢˜:\\", br(),\\nb(\\"åˆ°åº•æœ‰æ²¡æœ‰ä¸€ç§ç†æ€§çš„è½¯ä»¶ç¼–å†™æ–¹å¼ï¼Ÿ\\"), br(),\\n\\"æˆ‘ä¸æƒ³è®¨è®ºç°æœ‰çš„è½¯ä»¶å·¥ç¨‹å®è·µï¼Œæˆ‘åªè°ˆè°ˆæˆ‘å¿ƒç›®ä¸­ç†æƒ³çš„è½¯ä»¶å¼€å‘åº”è¯¥æ˜¯ä»€ä¹ˆæ ·çš„ã€‚\\", br(),\\n\\"ä»»ä½•ç¨‹åºéƒ½æ˜¯ä»å°å‘å±•åˆ°å¤§çš„ï¼Œå†åºå¤§çš„ç¨‹åºï¼Œä¹Ÿæ˜¯åœ¨ä¸ªäººèƒ½å¤Ÿç†è§£çš„å°ºåº¦ä¸‹è¢«ä¿®æ”¹çš„ï¼ˆåªè¦è¿˜æ˜¯ç”±äººç±»æ¥è¿›è¡Œç¼–ç¨‹ï¼‰ï¼Œè¿™ä¸ªå°ºåº¦æ˜¯æˆ‘ä»¬èƒ½åŠ›çš„è¾¹ç•Œã€‚\\", br(),\\n\\"è¿™æ„å‘³ç€å¯¹äºæŸä¸€ä¸ªå…·ä½“çš„è½¯ä»¶åŠŸèƒ½ï¼Œè™½ç„¶å®ƒçš„å®ç°å¯èƒ½ä¾èµ–äº†éå¸¸å¤æ‚çš„åŸºç¡€åº“æˆ–è€…å…¶ä»–ç»„ä»¶ï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½æœ¬èº«çš„è®¾è®¡ä¸€å®šæ˜¯ç®€å•çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»æŠŠå®ƒçš„æ•´ä¸ªè®¾è®¡æ”¾åœ¨ä¸€ä¸ªäººçš„å¤§è„‘é‡Œã€‚\\", br(),\\n\\"åº”è¯¥å­˜åœ¨ä¸€ç§æ‰‹æ®µï¼Œè®©æˆ‘ä»¬å¯ä»¥ä»ä¸€ä¸ªä»£ç åº“ä¸­æå–å‡ºæˆ‘ä»¬å½“å‰çœŸæ­£å…³å¿ƒçš„éƒ¨åˆ†ï¼Œå‘Šè¯‰å…¶ä»–äººï¼ˆä»¥åŠæˆ‘ä»¬è‡ªå·±ï¼‰ï¼Œå¯¹äºå½“å‰çš„é—®é¢˜ï¼Œæˆ‘ä»¬è®¾è®¡äº†æ€æ ·çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥åŠè¿™ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯å¦‚ä½•è¢«è½¬æ¢ä¸ºä»£ç çš„ã€‚\\", br(),\\n\\"ä¸éš¾æƒ³è±¡ï¼Œä¸€æ—¦è¿™æ ·çš„å·¥å…·å˜ä¸ºç°å®ï¼Œé‚£ä¹ˆå¯¹äºä»»æ„çš„ä¸€ä¸ªè½¯ä»¶è®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“ä¸ºè¯»è€…æä¾›å¤§é‡çš„å¯æ“ä½œå®ä¾‹ï¼Œè®©è¯»è€…äº²è‡ªä¿®æ”¹ï¼Œå‚ä¸åˆ°è½¯ä»¶çš„æ„å»ºè¿‡ç¨‹ä¸­æ¥ï¼Œè¿™æ˜¯ç°æœ‰çš„ä»»ä½•è½¯ä»¶å¼€å‘å·¥å…·æ‰€ä¸å…·å¤‡çš„èƒ½åŠ›ã€‚\\", br(),\\nbr(), \\"è¿™ç¯‡æ–‡ç« å°†å°è¯•å¦‚ä½•ä»æœ€ç®€å•çš„å·¥å…·å‡ºå‘ï¼ˆä¹Ÿå°±æ˜¯ç°åœ¨è¿™ä¸ªæ²™ç›’ç¯å¢ƒï¼‰ï¼Œæ„é€ å‡ºä¸€å¥—èƒ½å¤Ÿå®ç°è¿™ä¸€æ„¿æ™¯çš„å·¥å…·ã€‚\\"]})"},{"v":"style(document.documentElement, {width:\\"50%\\"}), style(document.body, {margin:8})\\nelm(document.body, {child:[\\"è¿™ä¸ªç¨‹åºä¼šæ‰“å°å½“å‰ç½‘é¡µçš„å†…å­˜ç”¨é‡ï¼š\\", $.sw = dom({tag:\\"span\\"}), \\"MB\\", dom({tag:\\"br\\"}), \\"æ³¨æ„å¯èƒ½çš„å†…å­˜æ³„æ¼ğŸ˜®\\"]})\\nconst upd = () => sw.innerText=(performance.memory.usedJSHeapSize/1024/1024).toFixed(1); setInterval(upd, 100), upd()"},{"v":"style(document.documentElement, {width:\\"50%\\"}), style(document.body, {margin:8})\\ncss(\\"pre\\", {fontFamily:\\"consolas\\", background:\\"#1d191d\\", color:\\"#cbd3d2\\"})\\ncss(\\"button\\", {verticalAlign:\\"bottom\\"})\\nconst mktag = t => $[t] = (...a) => dom({tag:t, child:a})\\n\\"h2 p br pre b\\".split(\\" \\").forEach(mktag)\\nconst a = (u, ...child) => elm(dom({tag:\\"a\\", child, href:u}), ()=>{})\\n\\nconst ctx = new AudioContext(), ack = [], ackf = [], acknf = []\\nforin(ctx, (v, k) => (ack.push(k), (isfct(v)?ackf:acknf).push([k, v])))\\n\\nconst exp0 = () => {\\n  const osc = ctx.createOscillator()\\n  osc.frequency.value = 440\\n  osc.connect(ctx.destination)\\n  osc.start()\\n  osc.stop(ctx.currentTime + 1)\\n}\\n\\nelm(document.body, {child:[\\nh2(\\"é€‰ä¸€ä¸ªä»€ä¹ˆæ ·çš„ä¸»é¢˜?\\"), \\"å®é™…ä¸Šä»€ä¹ˆä¸»é¢˜éƒ½å¯ä»¥ï¼Œåœ¨å®é™…çš„ç¼–ç¨‹éœ€æ±‚çš„é©±åŠ¨ä¸‹ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šé‡åˆ°éœ€è¦æ‹“å±•ç¼–è¾‘å™¨åŠŸèƒ½çš„æƒ…å†µï¼Œåˆ°é‚£ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å†æ¥è®¨è®ºå¦‚ä½•å‡çº§å·¥å…·ã€‚\\", br(),\\n\\"æ—¢ç„¶ä»€ä¹ˆéƒ½å¯ä»¥å†™ï¼Œé‚£ä¹ˆæˆ‘é€‰ä¸ªäººæ¯”è¾ƒæ„Ÿå…´è¶£çš„Web Audioä½œä¸ºæ¥ä¸‹æ¥çš„ç¼–ç¨‹ä¸»é¢˜ã€‚\\", br(), br(),\\na(\\"https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Audio_API\\", \\"Web Audioæ˜¯ä»€ä¹ˆï¼Ÿ\\"), br(), br(),\\n\\"è®©æˆ‘ç”¨new AudioContext()åˆ›å»ºä¸€ä¸ªWeb Audioä¸Šä¸‹æ–‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼š\\", br(), br(),\\n`{ ${ack.join(\\", \\")} }`, br(), br(),\\n\\"å¯èƒ½æœ‰ç‚¹å¤ªå¤æ‚äº†ï¼Œè®©æˆ‘ä»¬å…ˆå¿½ç•¥æ‰æ‰€æœ‰çš„å‡½æ•°ã€‚\\", br(), br(),\\n`{ ${acknf.map(([k, v]) => `${k}: ${v}`).join(\\", \\")} }`, br(), br(),\\n\\"å¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰ä¸€äº›å»¶è¿Ÿï¼Œé‡‡æ ·ç‡ç›¸å…³çš„æ•°æ®ï¼Œä»¥åŠdestinationï¼Œè¿™ä¸ªæ˜¯æœ€å…³é”®çš„ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªweb audioèŠ‚ç‚¹ç½‘ç»œçš„è¾“å‡ºã€‚\\", br(), br(),\\n\\"è€Œå‡½æ•°é‡Œé¢æœ‰ä¸€å¤§å †éƒ½æ˜¯createå¼€å¤´çš„ï¼š\\", br(), br(),\\n\\"{ \\", ...ackf.map(([k], i) => dom({tag:\\"span\\", child:k + (i === ackf.length - 1 ? \\"\\" : \\", \\"),\\n  style:{color:k.startsWith(\\"create\\")?\\"#0b0\\":\\"\\"}})), \\" }\\", br(), br(),\\n\\"è¿™äº›å‡½æ•°å…¨éƒ¨éƒ½æ˜¯ç”¨æ¥åˆ›å»ºç‰¹å®šèŠ‚ç‚¹çš„ï¼Œå‰©ä¸‹çš„å°±åªæœ‰ä¸‰ä¸ªäº‹ä»¶è§¦å‘å™¨ç›¸å…³çš„å‡½æ•°ï¼Œä¸€ä¸ªè§£ç å‡½æ•°ï¼Œä»¥åŠå‡ ä¸ªçŠ¶æ€æ§åˆ¶å‡½æ•°ï¼ŒåŸºæœ¬ä¸Šä»åå­—ä¹Ÿèƒ½çŒœåˆ°å®ƒä»¬çš„ä½œç”¨äº†ã€‚\\", br(), br(),\\n\\"è®©æˆ‘ä»¬è¯•ç€ç»„è£…ä¸€ä¸ªèŠ‚ç‚¹ï¼š\\", dom({tag:\\"button\\", child:\\"â–¶\\", onclick:()=>{exp0()}}), pre(fct2str(exp0)),\\n`åˆ›å»ºèŠ‚ç‚¹ï¼Œè®¾ç½®å±æ€§ï¼Œè¿æ¥åˆ°è¾“å‡ºï¼Œæ’­æ”¾ï¼Œåœæ­¢ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æ˜¯æŒ‰ç±»ä¼¼çš„æ¨¡å¼è¿›è¡Œæ“ä½œçš„ï¼ŒåŒºåˆ«åªåœ¨äºæ¯ä¸ªèŠ‚ç‚¹çš„å±æ€§å„ä¸ç›¸åŒã€‚`, br(), br(),\\n\\"ä¸€ç§æœ‰è¶£çš„éŸ³é¢‘åº”ç”¨æ˜¯å†™ä¸€ä¸ªåˆæˆå™¨ï¼Œè€Œè¿™éœ€è¦å¯¹åˆæˆå‡ºæ¥çš„éŸ³è‰²çš„å±æ€§æœ‰æ›´æ·±å±‚çš„äº†è§£ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å…ˆåšä¸ªæ³¢å½¢æ˜¾ç¤ºå™¨ã€‚\\",\\n]})"},{"v":"style(document.documentElement, {width:\\"50%\\"}), style(document.body, {margin:8})\\nconst mktag = t => $[t] = (...a) => dom({tag:t, child:a})\\n\\"h2 p br pre b\\".split(\\" \\").forEach(mktag)\\nconst onclick = () => {\\n  const r = initspeech2text(), lang = \\"zh-CN\\" // ä¿®æ”¹è¿™ä¸ªå­—ç¬¦ä¸²ä¸ºzh-CNå¯ä»¥è¯†åˆ«ä¸­æ–‡\\n  assign(r, { lang, interimResults: true, maxAlternatives: 1 })\\n  const s = () => trycatch(() => ($.tmp = dom({}, document.body), r.start()))\\n  const onresult = e => tmp.innerText = e.results[0][0].transcript\\n  assign(r, { onend: s, onresult }), s() }\\nelm(document.body, {child:[\\nh2(\\"ä¸€ä¸ªç®€å•çš„è¯­éŸ³è¯†åˆ«çš„ä¾‹å­\\"), \\"ï¼ˆ**å¹¶éæ–‡ç« çš„ä¸»è¦å†…å®¹**ï¼‰\\",\\ndom({tag:\\"button\\", child:\\"ç‚¹æˆ‘å¼€å§‹è¯­éŸ³è¯†åˆ«\\", onclick }), br(),\\n\\"ä¸‹é¢çš„å†…å®¹æ˜¯ä½¿ç”¨jsçš„toStringåŠŸèƒ½æ‹¿åˆ°çš„å‡½æ•°æºç ï¼Œä¹Ÿå°±æ˜¯è¯´å®é™…æ‰§è¡Œçš„ä»£ç ä¸æˆ‘å±•ç¤ºçš„ä»£ç çš„æ€»æ˜¯ä¸€è‡´çš„ï¼š\\",\\npre(fct2str(onclick)), \\"ç”±äºä¸€äº›å®ç°ä¸Šçš„åŸå› ï¼ŒåŒæ—¶å­˜åœ¨ä¸¤ä¸ªSpeechRecognitionå¯¹è±¡çš„è¯ä¼šå¯¼è‡´é¡µé¢éå¸¸å¡é¡¿ï¼Œæ‰€ä»¥æˆ‘åœ¨ç¼–è¾‘å™¨é‡Œå…ˆå®ç°äº†ä¸€ä¸ªinitspeech2textå‡½æ•°ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå…¬ç”¨çš„SpeechRecognitionå¯¹è±¡ï¼Œå…¶ä½™éƒ¨åˆ†å°±å’Œä¸€èˆ¬çš„jså®Œå…¨ä¸€è‡´äº†ã€‚\\", br(), br(),\\n\\"è¯­éŸ³è¯†åˆ«å‡ºçš„å†…å®¹æ˜¾ç¤ºåœ¨è¿™é‡Œï¼š\\"]})"},{"v":"style(document.documentElement, {width:\\"50%\\"}), style(document.body, {margin:8})\\ncss(\\"ul, ol\\", {margin:0, paddingLeft:\\"2em\\"})\\nconst mktag = t => $[t] = (...a) => dom({tag:t, child:a})\\n\\"h2 p br pre b\\".split(\\" \\").forEach(mktag)\\nconst updvoice = () => $.voices = s.getVoices()\\nconst s = assign(speechSynthesis, { onvoiceschanged: updvoice })\\nconst speak = t => (s.cancel(), s.speak(assign(\\n  new SpeechSynthesisUtterance(t), { onerror: log, voice: voices[vi] })))\\nupdvoice(); const vs={}; voices.forEach((v, i) => (vs[v.lang]??=[]).push((v.i = i, v)))\\nelm(document.body, {child:[ h2(\\"ä¸€ä¸ªç®€å•çš„æ–‡æœ¬æœ—è¯»çš„ä¾‹å­\\"),\\n  \\"ï¼ˆ**å¹¶éæ–‡ç« çš„ä¸»è¦å†…å®¹**ï¼‰ä½¿ç”¨speakå‡½æ•°æœ—è¯»æ–‡æœ¬ï¼Œå¯ç”¨çš„è¯­éŸ³åˆ—è¡¨ï¼š\\", br(), $.ll=dom()]})\\nconst item = v => dom({ tag: \\"li\\", child: `${v.i}: ${v.name}` }); forin(vs, (v, k) =>\\n  elm(ll, { child: [br(), k + \\": \\", dom({ tag: \\"ul\\", child: v.map(item) })] }))\\n\\nconst vi = 0 // ç”¨è¿™ä¸ªåºå·é€‰æ‹©è¯­éŸ³\\nspeak(``) // æƒ³è¯´çš„è¯å†™åœ¨è¿™é‡Œ"}]}'
store.def(preload)

const fct2str = (f, s = String(f)) => {
  const t = s.slice(s.indexOf("{") + 1, s.lastIndexOf("}"))
  const a = t.split(/\r?\n/); if (a[0] === "") a.shift()
  const n = a[0].match(/^[\s]+/)?.[0].length ?? 0
  return a.map(v => v.slice(n)).join("\r\n").trim()
}

const lh = 18, setth = t => style(t, { height: t.value.split(/\r?\n/).length * lh })
const editor = d => {
  let sdbx, r = dom({ style: { display: "flex" } }), onkeydown = e =>
    e.key.toLowerCase() === "s" && (e.ctrlKey || e.altKey) ? (e.preventDefault(), upd())
      : e.key.toLowerCase() === "n" && e.altKey ? splice(d.i + 1, 0, { v: "" })
        : e.key.toLowerCase() === "w" && e.altKey ? splice(d.i, 1) : 0
  const upd = () => trycatch(() => (d.v = t.value, save(), refresh(),
    style(t, { color: "" })), e => (style(t, { color: "red" }), panic(e)))
  const t = dom({ tag: "textarea", value: d.v, onkeydown })
  elm(t, { oninput: () => setth(t), spellcheck: false })
  style(t, { resize: "none", width: "calc(50% - 6px)", lineHeight: lh })
  style(t, { whiteSpace: "pre", overflow: "hidden", fontFamily: "consolas, courier" })
  const refresh = () => (sdbx?.destroy(), sdbx = sandbox(assign(scope($), { extra: { fct2str } })),
    r = elm(r, { child: [t, sdbx.document.documentElement], diff: true }),
    Function("$", `with($){\n${d.v}\n}`)(sdbx))
  setth(t), setTimeout(refresh), d.d = r; return d
}

$.save = () => store.set(gsl, data.map(({ v }) => ({ v })))
$.sync = () => elm(editors, { child: data.map(({ d }) => d), diff: true })
$.splice = (s, c, ...a) => (data.splice(s, c, ...a.map(editor)),
  data.length > 0 ? 0 : data.push(editor({ v: "" })),
  forrg(data.length, i => data[i].i = i), sync())
const gsl = "global-state-location"; store.get(gsl).then(v => (
  body.append($.editors = dom()), $.data = [], splice(0, 0, ...v ?? [])))