<h1>æ–‡å­¦ç¼–ç¨‹å®è·µ4</h1>
<div class="sub-title">â€”â€”ç¼–æ›²è½¯ä»¶</div>
<div class="right">â—† ch3coohlink@2022</div>
è¿™ç¯‡æ–‡æ¡£å°†é€šè¿‡ç¼–æ›²è½¯ä»¶çš„å¼€å‘è¿‡ç¨‹ä¸ºæ–‡å­¦ç¼–ç¨‹å·¥å…·çš„è®¾è®¡æä¾›åé¦ˆã€‚
<div class="spbar"></div>
ä¸€äº›åŸºç¡€è®¾æ–½ä»£ç ï¼š
###code
setTimeout(() => {
  const html = document.documentElement
  html.scroll(0, 6500)
}, 100)
###code
$.ws = new WebSocket("ws://localhost:9000")
ws.addEventListener("close", console.log)
ws.addEventListener("message", e => {
  if(e.data === "refresh") { location.reload() } })
###code
const _lg = console.log; $.log = (...a) => (_lg(...a), a[a.length - 1])
###code
$.isnum = o => typeof o == "number", $.isfct = o => typeof o == "function"
$.isstr = o => typeof o == "string", $.isbgi = o => typeof o == "bigint"
$.isudf = o => o === undefined, $.isnth = o => isudf(o) || isnul(o)
$.isobj = o => !!o && typeof o == "object", $.isnul = o => o === null
$.isarr = Array.isArray, $.asarr = v => isarr(v) ? v : [v]
$.isnumstr = s => isstr(s) && !isNaN(Number(s))
###code
$.proto = Object.getPrototypeOf, $.property = Object.defineProperty
$.assign = Object.assign, $.obj = $.create = Object.create
###code
$.style = (e, ...ss) => {
  for(const s of ss) {
    for(const k in s) {
      let v = s[k]; isnum(v) ? v = `${v}px` : 0
      if(e.style[k] !== v) { e.style[k] = v }
    }
  } return e
}
###code
const elm = document.createElement.bind(document)
$.dom = (o = {}, p, n = o.tag ?? "div") => {
  const e = elm(n); for(const k in o) {
    const v = o[k]; switch(k) {
      case "class": e.className = isarr(v) ? v.join(" ") : v ; break;
      case "child": e.append(...asarr(v)); break;
      case "style": style(e, ...asarr(v)); break;
      default: e[k] !== v ? e[k] = v : 0; break;
    }
  } if(p) { p.append(e) } return e
}
###code
$.cutheadtail = (a, b) => {
  let al = a.length, bl = b.length, l = Math.min(al, bl), s = 0, e = al, t = bl, x, y
  for (;;s++) { if (s >= l || a[s] !== b[s]) { break } }
  for (;;e--, t--) { if ((x = e - 1) <= s || (y = t - 1) <= s || a[x] !== b[y]) { break } }
  return [s, e, t]
}
###code
let d = () => { throw "duplication" }
$.simpdiff = (n, p, keeporder = true) => {
  let [s, e, t] = cutheadtail(n, p), o = new Map, r = new Set, w = []
  for(let i = s; i < e; i++) { let v = n[i]; o.has(v) ? d() : o.set(v, i) }
  for(let i = s; i < t; i++) { let v = p[i]; !o.has(v) ? w.unshift(i) : r.has(v) ? d() : r.add(v) }
  for(let i of w) { p.splice(i, 1) }
  for(let i = s; i < e; i++) { let v = n[i]; r.has(v) ? 0 : p.splice(i, 0, v) }
  if(keeporder) {
    w = []
    for(let i = s; i < e; i++){ let a = n[i], b = p[i]; a === b ? 0 : w.unshift([i, o.get(b), b]) }
    for(let [i] of w) { p.splice(i, 1) }
    w = w.sort(([, a], [, b]) => a - b)
    for(let [, i, v] of w) { p.splice(i, 0, v) }
  }
}
###code
$.domarr = (e, d = e.childNodes) => {
  const splice = (i, c, a) => c ? e.removeChild(d[i]) : e.insertBefore(a, d[i])
  return new Proxy({}, { get: (_, k) => k === "splice" ? splice : d[k] })
}
###code
const gebcn = document.getElementsByClassName.bind(document)
const gebid = document.getElementById.bind(document)
const tbc = name => [...gebcn(name)].map(v => v.textContent)
const tbi = name => gebid(name).textContent
$.textbyid = (...n) => n.map(tbi)
$.textbyclass = (...names) => [].concat(...names.map(v => tbc(v)))
$.tofunc = (...a) => new Function("$", "with($){ " +
  [].concat(...a).map(v => `{\n${v}}`).join(" ") + " }return $")
$.tofuncf = n => tofunc(textbyclass(n))
$.exec = (f, o) => (f(o), o)
$.execf = (n, ...a) => exec(tofunc(textbyclass(n)), ...a)
###
<div class="spbar"></div>
<h2>éŸ³é¢‘åŸºç¡€</h2>
åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡ï¼š
###code
$.ctx = new AudioContext()
###
æœ€å°çš„å‘å£°ä¾‹å­ï¼š
###code
root.append("æ’­æ”¾ä¸€ç§’é’Ÿ440Hzæ­£å¼¦æ³¢ï¼š", dom({
  tag:"button", child:"\u25b6", onclick:() => {
    const osc = ctx.createOscillator()
    osc.frequency.value = 440
    osc.connect(ctx.destination)
    osc.start()
    osc.stop(ctx.currentTime + 1)
}}))
###
<br>åˆ›å»ºåˆ†æå™¨èŠ‚ç‚¹ï¼š
###code
$.anl = ctx.createAnalyser()
anl.connect(ctx.destination)
###
<br>ç»˜åˆ¶å‡½æ•°ï¼š
###code
$.drawanl = (anl, cvs, whichdata="time", f = () => {
  requestAnimationFrame(f)
  const length = anl.frequencyBinCount, ist = whichdata === "time"
  const td = new Uint8Array(length), ctx = cvs.getContext("2d")
  anl[ist ? "getByteTimeDomainData" : "getByteFrequencyData"](td)
  const { width, height } = cvs, slice = width * 1.0 / length
  ctx.fillStyle = "#ccc", ctx.fillRect(0, 0, width, height)
  ctx.strokeStyle = "#111", ctx.beginPath()
  for (let i = 0; i < length; i++) {
    const v = (ist ? td[i] : 256 - td[i]) / 128
    const x = i * slice, y = v * (height-20) / 2 + 10
    ctx[i === 0 ? "moveTo" : "lineTo"](x, y)
  } ctx.stroke()
}) => f()
###
å®é™…ç»˜åˆ¶æ—¶åŸŸå’Œé¢‘åŸŸä¿¡æ¯ï¼ˆå¢åŠ äº†ä¸€ä¸ªæŒ‰é’®å¸®åŠ©æ‚¬åœå¯è§†åŒ–ï¼‰ï¼š
###code
$.fitsize = cvs => (cvs.width = cvs.clientWidth * devicePixelRatio,
  cvs.height = cvs.clientHeight * devicePixelRatio, cvs)
const root = style($.root, { position:"relative"})
const cvsstyle = {boxSizing:"border-box", padding:"0.2em", width:"50%", height:100}
const cvsa = dom({tag:"canvas", style: cvsstyle}, root)
const cvsb = dom({tag:"canvas", style: cvsstyle}, root)
drawanl(anl, fitsize(cvsa), "time")
drawanl(anl, fitsize(cvsb), "freq")
const bt = dom({ tag: "button", child: "ğŸ“Œ", style: {
  position: "absolute", right: "-0.2em", width:"2.5em", height:"2.5em" },
  onclick: () => { if(bt.textContent === "ğŸ“Œ") {
      bt.textContent = "â†©", style(root, {position:"sticky", top:"0.2em"}) } else {
      bt.textContent = "ğŸ“Œ", style(root, {position:"relative", top:""}) } } }, root)
addEventListener("resize", () => (fitsize(cvsa), fitsize(cvsb)))
//bt.onclick()
###
<br>ä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„æœ€å°å‘å£°éŸ³ä¾‹å­ï¼Œå°†å…¶è¿æ¥åˆ°åˆ†æå™¨ä¸Šï¼š
###code
root.append("ç°åœ¨æ’­æ”¾å£°éŸ³å¯ä»¥çœ‹åˆ°æ—¶åŸŸå’Œé¢‘åŸŸä¿¡æ¯çš„å¯è§†åŒ–ï¼š", dom({
  tag: "button", child: "\u25b6", onclick: () => {
    const osc = ctx.createOscillator()
    osc.frequency.value = 440
    osc.connect(anl)
    osc.start()
    osc.stop(ctx.currentTime + 1)
}}))
###
<br>å¢åŠ ä¸€ä¸ªæ»‘æ¡ç”¨æ¥ä¿®æ”¹å‚…é‡Œå¶åˆ†æçš„å‚æ•°ï¼š
###code
const n = dom({tag:"span", child:anl.fftSize})
const v = [256, 512, 1024, 2048, 4096, 8192, 16384]
const i = dom({tag:"input", type:"range",
  value:v.indexOf(2048), min:0, max:v.length-1, step:1,
  oninput: e => { n.textContent = anl.fftSize = v[i.value]
  log(anl.frequencyBinCount) } })
root.append("è®¾ç½®åˆ†æå™¨çš„fftSizeï¼š", i, n)
###
<br>
ä¸Šé¢çš„ä»£ç æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨å£°éŸ³å¯åŠ¨å’Œç»“æŸçš„æ—¶å€™ç”±äºéŸ³é‡çš„çªå˜ä¼šå‘å‡ºä¸€ä¸ªçˆ†ç ´éŸ³ã€‚
ä¸‹é¢çš„ä»£ç é€šè¿‡gainèŠ‚ç‚¹æ§åˆ¶éŸ³é‡æ·¡å…¥æ·¡å‡ºï¼Œä»è€Œæ¶ˆé™¤äº†çˆ†ç ´éŸ³ï¼š
###code
root.append("è¿™ä¸ªå£°éŸ³èŠ‚ç‚¹åœ¨å¯åŠ¨å’Œåœæ­¢æ—¶ä¸ä¼šæœ‰çˆ†ç ´éŸ³ï¼š", dom({
  tag: "button", child: "\u25b6", onclick: () => {
    const t = 0.05
    const osc = ctx.createOscillator()
    const gain = ctx.createGain()

    osc.connect(gain)
    gain.connect(anl)

    // å…ˆå°†éŸ³é‡è®¾ä¸º0ï¼Œåœ¨0.01ç§’ä¹‹å†…è¿‡æ¸¡åˆ°1
    gain.gain.value = 0
    gain.gain.linearRampToValueAtTime(1, ctx.currentTime + t)

    osc.frequency.value = 440
    osc.start()
    
    const st = ctx.currentTime + 1
    gain.gain.value = gain.gain.value
    gain.gain.setValueAtTime(1, st)
    gain.gain.linearRampToValueAtTime(0, st + t)
}}))
###
<br>è‡³æ­¤æˆ‘ä»¬åº”è¯¥å¯¹web audioçš„ä½¿ç”¨æœ‰äº†ä¸€å®šçš„æ¦‚å¿µã€‚
<div class="spbar"></div>
<h2>éŸ³åºå™¨</h2>
å¯¹äºç¼–æ›²è½¯ä»¶è€Œè¨€ï¼ŒéŸ³åºå™¨æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„ç»„ä»¶ï¼ŒDAWé‡Œå¸¸è§çš„é’¢ç´å·å¸˜å’Œé¼“æœºéƒ½æ˜¯ä¸€ç§ç¼–è¾‘éŸ³åºçš„å·¥å…·ã€‚<br>
ä½†ç°åœ¨æˆ‘ä»¬å…ˆä¸è®¨è®ºéŸ³åºçš„ç¼–è¾‘ï¼Œè€Œæ˜¯åªå…³æ³¨å¦‚ä½•å®ç°éŸ³åºçš„æ’­æ”¾ã€‚<br>
æŠ½è±¡åœ°è¯´ï¼ŒéŸ³åºå°±æ˜¯ä¸€ç³»åˆ—éŸ³é¢‘äº‹ä»¶ï¼Œè€ŒéŸ³åºå™¨çš„åŠŸèƒ½å°±æ˜¯å‡†æ—¶æ‰§è¡Œè¿™äº›éŸ³é¢‘äº‹ä»¶ã€‚<br>
è¯´å¾—å†ç²—æš´ä¸€äº›ï¼Œå…¶å®å°±æ˜¯åœ¨ä¸€äº›ç‰¹å®šçš„æ—¶é—´ç‚¹è¿è¡Œä¸€äº›ç‰¹å®šçš„ä»£ç ã€‚<br>
ç±»ä¼¼ä¸‹é¢çš„ä¼ªä»£ç ï¼š<br>
<pre>
setTimeout(event0, 0)
setTimeout(event1, 10)
setTimeout(event2, 30)
//...
</pre>
ç†è®ºä¸Šè¿™æ®µä»£ç åº”è¯¥å¯ä»¥å®Œæˆä»»åŠ¡ï¼Œä½†æ˜¯å¾ˆå¯æƒœï¼Œjsçš„setTimeoutå‡½æ•°æ²¡æœ‰è¿™ä¹ˆé«˜çš„ç²¾åº¦ï¼Œè™½ç„¶æˆ‘è®¾ç½®è®©å®ƒ10msä¹‹åæ‰§è¡Œevent1ï¼Œä½†æ˜¯å®é™…ä¸Šå¯èƒ½åˆ°äº†åå‡ æ¯«ç§’event1è¿™ä¸ªå‡½æ•°æ‰ä¼šè¢«æ‰§è¡Œï¼Œè¿™æ ·çš„ç²¾åº¦å¯¹äºéŸ³é¢‘åº”ç”¨è€Œè¨€æ˜¯ä¸èƒ½å¿å—çš„ã€‚<br>
è¦æƒ³ä»¥è¶³å¤Ÿçš„æ—¶é—´ç²¾åº¦è§¦å‘éŸ³é¢‘äº‹ä»¶ï¼Œåœ¨web audioä¸­ï¼Œå°±éœ€è¦æå‰è¿›è¡Œè®¡åˆ’ã€‚<br>
ç”¨ä¸‹é¢çš„ä¼ªä»£ç ç†è§£ä¸€ä¸‹ï¼š
<pre>
audionode0.start(0)
audionode1.start(10)
audionode2.start(30)
//...
</pre>
è¿™æ®µä»£ç å’Œä¸Šé¢çš„åŒºåˆ«åœ¨äºï¼Œæˆ‘ä»¬å¤±å»äº†æ‰§è¡Œä»»æ„å‡½æ•°çš„èƒ½åŠ›ï¼Œåªèƒ½å¯¹web audioç»™å®šçš„åŠŸèƒ½è§„åˆ’æ—¶é—´ï¼Œä½†ç›¸å¯¹åº”çš„ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ç²¾ç¡®çš„è®¡æ—¶ã€‚<br>
ç°åœ¨æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€æ®µéŸ³åºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨ç”¨æˆ·æŒ‰ä¸‹æ’­æ”¾æŒ‰é’®çš„åŒæ—¶ï¼Œå°†æ‰€æœ‰çš„éŸ³é¢‘äº‹ä»¶éƒ½ç”¨ä¸Šé¢çš„æ–¹å¼è§„åˆ’èµ·æ¥ï¼Œé‚£ä¹ˆæœºå™¨å°±èƒ½æ­£ç¡®åœ°æ’­æ”¾è¿™æ®µéŸ³åºã€‚<br>
ä½†è¿™æ ·åšæœ‰ä¸ªå·¨å¤§çš„ç¼ºé™·ï¼Œä¸€æ—¦æˆ‘ä»¬å¼€å§‹æ’­æ”¾ï¼Œå°±æ²¡æœ‰æš‚åœçš„æœºä¼šäº†ï¼Œæ›´åˆ«æè¦è§£é™¤æš‚åœé‡æ–°æ’­æ”¾ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šé¢è¿™ç§ç®€å•çš„æœºåˆ¶å¯¹äºçœŸæ­£çš„éŸ³åºå™¨è€Œè¨€æ˜¯ä¸å¤Ÿç”¨çš„ï¼Œæˆ‘ä»¬è¿˜è¦é¢å¤–è®¾è®¡ä¸€ä¸ªæ–¹æ¡ˆè§£å†³è¿™ä¸ªé—®é¢˜ã€‚<br>
é¦–å…ˆå‡†å¤‡ä¸€äº›åŸºç¡€ä»£ç ï¼š
<pre class="sequncer_0">
$.now = () => ctx.currentTime
$.loop = () => (requestAnimationFrame(loop), poll())
$.seq = [], $.poll = () => {}, loop()
</pre>
è¿™é‡Œå‡†å¤‡äº†ä¸¤æ ·ä¸œè¥¿ï¼Œä¸€æ˜¯seqæ•°ç»„ï¼Œä¹‹åæˆ‘ä»¬è¦æŠŠéŸ³åºæ”¾åœ¨é‡Œé¢ã€‚<br>
äºŒæ˜¯pollå‡½æ•°ï¼Œè¿™é‡Œä½¿ç”¨requestAnimationFrameæ¯æ¬¡ç»˜åˆ¶è°ƒç”¨ä¸€æ¬¡pollã€‚<br>
æˆ‘çš„è®¡åˆ’æ˜¯ï¼šæ¯éš”ä¸€æ®µæ—¶é—´å°±ç”¨pollå‡½æ•°å°†æœ€è¿‘éœ€è¦è¢«è§„åˆ’çš„äº‹ä»¶è§„åˆ’åˆ°web audioçš„åˆ—è¡¨é‡Œï¼Œå…·ä½“å®ç°å¯ä»¥çœ‹ä»£ç ï¼š<br>
<pre class="sequncer_0">
$.scheduleT = 0.05, $.startT = 0, $.passT = 0
$.playing = false, $.method = {}, $.poll = () => {
  if(!playing) { return }
  const n = now(), t = n - startT + passT
  while(seq[0] && seq[0].time < (t + scheduleT)) {
    const e = seq.shift()
    method[e.type]?.(e, e.time - t + n)
  }
}
</pre>
æœ€åæä¾›ä¸€äº›ç®€å•çš„èƒ¶æ°´å‡½æ•°ï¼š
<pre class="sequncer_0">
$.play = () => ($.playing = true, $.startT = now(), poll())
$.pause = (t = now() - startT) => {
  const n = now(); $.playing = false, $.passT += n - startT
  method.stop({ type: "stop" }, n + scheduleT)
}
</pre>
<pre class="sequncer_0", id="audiosource_0">
$.osc = ctx.createOscillator()
const gain = ctx.createGain()
osc.connect(gain), gain.connect(anl)
gain.gain.value = 0
osc.frequency.value = 440
const dt = 0.1; osc.start()
method.start = (e, t) => {
  gain.gain.setTargetAtTime(0, t, 0.5)
  gain.gain.linearRampToValueAtTime(1, t + dt)
}
method.stop = (e, t) => {
  if(gain.gain.value === 0) { return }
  gain.gain.setTargetAtTime(1, t, 0.5)
  gain.gain.linearRampToValueAtTime(0, t + dt)
}
</pre>
å†™ä¸ªç®€å•çš„demoï¼š
###code
const seq = execf("sequncer_0", obj($))
const sa = t => ({type: "start", time: t})
const sp = t => ({type: "stop", time: t})
const test = () => {
  try { seq.osc.start() } catch(e){  }
  seq.passT = 0
  seq.seq = [sa(1), sp(1.5), sa(2.5), sp(4), sa(4.5), sp(5)]
  seq.play()
  setTimeout(() => seq.pause(), 3000)
  setTimeout(() => seq.play(), 4000)
}
root.append("æŒ‰ä¸‹æŒ‰é’®å¼€å§‹æµ‹è¯•å‘å£°åºåˆ—ï¼š", dom({tag:"button", child:"â–¶", onclick:test}))
###
<div class="spbar"></div>
ä¸Šé¢çš„demoå®ç°äº†ä¸€ä¸ªç®€å•çš„éŸ³åºå™¨ï¼Œå¹¶å…·æœ‰äº†æ’­æ”¾å’Œæš‚åœçš„åŠŸèƒ½ï¼Œä½†ä¹Ÿæš´éœ²äº†æ–°çš„é—®é¢˜ï¼š<br>
<br>
é¦–å…ˆï¼Œç”±äºæˆ‘ä¸€å¼€å§‹å‡è®¾æ¯æ¬¡æ’­æ”¾éƒ½æ˜¯ä»å¤´æ”¾åˆ°å°¾ï¼Œå› æ­¤é€‰æ‹©äº†ä¸€ç§ä¸æ–­ä»æ•°ç»„ä¸­åˆ é™¤å·²ç»å¤„ç†è¿‡çš„äº‹ä»¶çš„æ–¹æ³•ï¼Œä½†è¿™å…¶å®æ˜¯ä¸ç¬¦åˆéŸ³åºå™¨çš„å®é™…éœ€æ±‚çš„ï¼Œæˆ‘ä»¬çš„ç›®æ ‡åº”è¯¥æ˜¯å…è®¸éŸ³åºå™¨ä»ä»»æ„æ—¶é—´ç‚¹å¼€å§‹æ’­æ”¾ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è®¾è®¡æ›´å®Œå–„çš„æœºåˆ¶ã€‚<br>
<br>
å…¶æ¬¡ï¼Œåœ¨ä¸Šé¢çš„demoä¸­å¯ä»¥å‘ç°ï¼Œä¸€ä¸ªå£°éŸ³å¯ä»¥è¢«å¯åŠ¨å¤šæ¬¡ï¼Œä¹Ÿå°±æ˜¯åœ¨å‰ä¸€ä¸ªå£°éŸ³è¿˜æ²¡æœ‰æ”¶åˆ°ç»“æŸäº‹ä»¶çš„æƒ…å†µä¸‹ï¼Œæœ‰å¯èƒ½æ”¶åˆ°å¯¹åŒä¸€ä¸ªå£°éŸ³çš„å‘å£°æŒ‡ä»¤ï¼Œéœ€è¦è€ƒè™‘å¦‚ä½•åº”å¯¹è¿™ç§æƒ…å½¢ã€‚<br>
<div class="spbar"></div>
å…ˆæ¥è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š
<pre class="sequncer_1">
$.now = () => ctx.currentTime
$.loop = () => (requestAnimationFrame(loop), poll())
$.seq = [], $.poll = () => {}, loop()
</pre>
<pre class="sequncer_1">
$.scheT = 0.05, $.sequT = 0, $.starT = 0, $.paused = true, $.method = {}
$.poll = () => { // æ ¹æ®å½“å‰æ—¶é—´ä»éŸ³åºæ•°ç»„ä¸­æ‰¾åˆ°éœ€è¦æ’­æ”¾çš„éŸ³åºåŒºé—´
  if(paused) { return } const nt = now(), t = nt - starT + sequT
  for(let i = find(t), e = find(t + scheT); i < e; i++) {
    const e = seq[i]; method[e.type]?.(e, e.time - t + nt) } }
</pre>
<pre class="sequncer_1">
// ç®€å•ç²—æš´çš„æœç´¢å®ç°ï¼Œåç»­å¯ä»¥æ›¿æ¢ä¸ºäºŒåˆ†æœç´¢
$.find = (t, i = seq.findIndex(v => v.time > t)) => i < 0 ? seq.length : i
</pre>
<pre class="sequncer_1">
$.play = (t = sequT) => ($.paused = false, $.sequT = t, $.starT = now(), poll())
$.pause = (n = now()) => ($.sequT = n - starT,
  $.paused = true, method.stop({type:"stop"}, n + scheT))
</pre>
ä½¿ç”¨å’Œå‰ä¸€ä¸ªdemoå®Œå…¨ç›¸åŒçš„éŸ³æºä»£ç ï¼š
###code
const seq = exec(tofunc(textbyclass("sequncer_1"), textbyid("audiosource_0")), obj($))
const sa = t => ({type: "start", time: t})
const sp = t => ({type: "stop", time: t})
seq.seq = [sa(1), sp(1.5), sa(2.5), sp(4), sa(4.5), sp(5)]
const test = () => {
  try { seq.osc.start() } catch(e){  }
  seq.play(0)
  setTimeout(() => seq.pause(), 3000)
  setTimeout(() => seq.play(), 4000)
}
root.append("DEMO 2ï¼š", dom({tag:"button", child:"â–¶", onclick:test}))
###
<div class="spbar"></div>
å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªdemoçš„ä»£ç å’Œä¹‹å‰æœ‰ä¸€äº›ä¸åŒï¼Œæœ€æ˜æ˜¾çš„åœ°æ–¹æ˜¯ï¼Œä¸éœ€è¦æ¯æ¬¡é‡ç½®æ’­æ”¾çš„å†…å®¹å’Œè¿›åº¦äº†ï¼Œå› ä¸ºç°åœ¨çš„playå‡½æ•°æ”¯æŒä»ä»»æ„æ—¶é—´ç‚¹å¼€å§‹æ’­æ”¾ã€‚<br>
ä½†è¿˜æœ‰ä¸€äº›ä¸é‚£ä¹ˆæ˜æ˜¾çš„å˜åŒ–ï¼Œå¹¶ä¸”è¿™ç§å˜åŒ–éå¸¸æœ‰è¶£ï¼šåœ¨è¿™ä¸ªdemoä¸­ï¼Œpollå‡½æ•°çš„æ•ˆæœä»…ä»…å’Œè®¾ç½®çš„æ’­æ”¾æ—¶é—´æœ‰å…³ï¼Œæ‰€ä»¥å®ƒå¹¶ä¸çŸ¥é“ä¸€ä¸ªäº‹ä»¶æ˜¯å¦è¢«è§¦å‘è¿‡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è®¾å®šçš„schedule_timeæ¯”pollè¿è¡Œçš„é—´éš”æ›´é•¿æ—¶ï¼ŒåŒä¸€ä¸ªäº‹ä»¶ä¼šè¢«è§¦å‘å¤šæ¬¡ã€‚è€Œç¥å¥‡çš„åœ°æ–¹åœ¨äºï¼Œç”±äºæ¯æ¬¡è§„åˆ’çš„éŸ³é¢‘äº‹ä»¶è§¦å‘æ—¶é—´éƒ½ç›¸åŒï¼Œæ‰€ä»¥å³ä½¿è§¦å‘å¤šæ¬¡ä¹Ÿä¸ä¼šå½±å“å£°éŸ³çš„æ­£ç¡®æ’­æ”¾ã€‚æ­£å› å¦‚æ­¤ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰ç¬¬ä¸€æ—¶é—´å‘ç°è¿™ä¸ªbugï¼Œè€Œæ˜¯ç›´åˆ°å°è¯•æ‰“å°ä¸€äº›ä¿¡æ¯çš„æ—¶å€™æ‰æ³¨æ„åˆ°ã€‚<br>
<br>
åç»­å¯ä»¥é€šè¿‡è®°å½•å·²ç»è§„åˆ’åˆ°çš„æ—¶é—´æ¥è¿›è¡Œä¿®æ­£ã€‚<br>
<div class="spbar"></div>
æ¥ä¸‹æ¥å¼€å§‹æ€è€ƒç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ–è€…è¯´ï¼Œæ¥å®ç°ä¸€ä¸ªæ›´æœ‰æ„æ€çš„éŸ³æºã€‚<br>
ç°åœ¨çš„éŸ³æºé™¤äº†å¼€å§‹å‘å£°å’Œåœæ­¢å‘å£°ä¹‹å¤–å°±ä»€ä¹ˆéƒ½ä¸èƒ½åšï¼Œéå¸¸çš„æ— èŠï¼Œè®©æˆ‘ä»¬ä¸ºå®ƒæ‹“å±•ä¸€äº›åŠŸèƒ½ã€‚<br>
###code
const seq = exec(tofunc(textbyclass("sequncer_1"), textbyid("audiosource_0")), obj($))
const sa = t => ({type: "start", time: t})
const sp = t => ({type: "stop", time: t})
seq.seq = [sa(1), sa(1.5), sa(2.5), sp(4), sa(4.5), sp(5)]
const test = () => {
  try { seq.osc.start() } catch(e){  }
  seq.play(0)
  setTimeout(() => seq.pause(), 3000)
  setTimeout(() => seq.play(), 4000)
}
test()
###
<div class="spbar"></div>
<pre class="sequncer_1">
$.find = (t, s = 0, e = seq.length - 1) => {
  if(s > e) return seq.length
  let m = Math.floor()
}
let recursiveFunction = function (arr, x, start, end) {
      
    // Base Condition
    if (start > end) return false;
  
    // Find the middle index
    let mid=Math.floor((start + end)/2);
  
    // Compare mid with given key x
    if (arr[mid]===x) return true;
         
    // If element at mid is greater than x,
    // search in the left half of mid
    if(arr[mid] > x)
        return recursiveFunction(arr, x, start, mid-1);
    else
 
        // If element at mid is smaller than x,
        // search in the right half of mid
        return recursiveFunction(arr, x, mid+1, end);
}
</pre>
###
<div class="spbar"></div>
<pre class="sequncer_0">
$.error = e => { throw new Error(e) }
$.notime = () => error("no time specified in audio event")
</pre>
###
<pre>const snarr = "A A# B C C# D D# E F F# G G#".split(" ")
const num2sn = (i, k = i%12, h = Math.floor(i/12)) => sndict[k] + (k > 2 ? h+1 : h)
const sndct = {}; forrg(88, i => sndct[num2sn(i)] = i)
const parse = i => i.trim().split(/\s+/).map(v => v.toUpperCase())
  .map(v => v in sndct ? sndct[v] : panic(`unknown sound name: "${v}"`))

const bpm = 120, dt = 60 / bpm
return (i, notes = parse(i)) => {
  let t = ctx.currentTime, stop
  const pollnote = () => {
    while(t &lt;= ctx.currentTime + 0.1) {
      const n = notes.shift(); if(!n) { stop?.(); return }
      stop?.(), stop = playsoundat(n, t), t += dt // åœæ­¢ä¸Šä¸€ä¸ªéŸ³ï¼Œæ’­æ”¾å½“å‰éŸ³
    } setTimeout(pollnote, 50)
  }; pollnote()
}</pre>